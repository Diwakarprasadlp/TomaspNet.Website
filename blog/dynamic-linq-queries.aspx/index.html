<!DOCTYPE html>
<!--[if IE 8]> 				 <html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<head>
  <meta charset="utf-8">
  <title>Building LINQ Queries at Runtime in C#</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Common criticism of LINQ is that it doesn't support a scenario where queries are build dynamically at the runtime. In this article I show that this can be acutally done very well for most of the common scenarios.">
  <meta name="author" content="Tomas Petricek">

  <!-- Reference Foundation -->
  <link rel="stylesheet" href="http://tomasp.net/css/foundation.css">
  <script src="js/vendor/custom.modernizr.js"></script>

  <link rel="alternate" type="application/rss+xml" href="http://tomasp.net/rss.xml" title="RSS feed for Tomas Petricek's blog">
  <link rel="icon" type="image/png" href="http://tomasp.net/img/favicon.png" />

  <!-- Reference custom CSS and tooltips -->
  <link type="text/css" rel="stylesheet" href="http://tomasp.net/custom/style.css" />
  <script type="text/javascript" src="http://tomasp.net/custom/tooltips.js"></script>
  <link type="text/css" rel="stylesheet" href="http://tomasp.net/custom/tooltips.css" />
  <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    <meta name="twitter:card" content="summary">
  <meta name="twitter:creator" content="@tomaspetricek">
  <meta name="twitter:title" content="Building LINQ Queries at Runtime in C#">
  <meta name="twitter:description" content="Common criticism of LINQ is that it doesn't support a scenario where queries are build dynamically at the runtime. In this article I show that this can be acutally done very well for most of the common scenarios.">
</head>
<body>

   <header id="top-header">
    <div class="row">
      <div class="twelve columns">
        <h1><a href="http://tomasp.net/">Tomas Petricek's blog</a></h1>
        <p>Writing about practical F# coding and programming language research</p>
      </div>
    </div>
  </header>

  <header class="top-bar-header">
    <div class="contain-to-grid sticky">
    <nav class="top-bar">

    <ul class="title-area">
      <li class="name"><h1><a href="#"></a></h1></li>
      <li class="toggle-topbar menu-icon"><a href="#"><span>Menu</span></a></li>
    </ul>
    <section class="top-bar-section">
      <ul class="right">
        <li><a href="http://tomasp.net/blog/index.html">Blog</a></li>
        <li><a href="http://functional-programming.net">Books</a></li>
        <li><a href="http://fsharpworks.com/workshops.html">Trainings</a></li>
        <li><a href="http://fsharpworks.com">Consulting</a></li>
        <li><a href="http://tomasp.net/academic">Research</a></li>
      </ul>
    </section>

    </nav></div>
  </header>

  
<div class="row">
	<div class="large-8 columns main-content">
    <content>
      
<h1>Building LINQ Queries at Runtime in C#</h1>
<p>Since the first beta versions of LINQ we could hear comments that it is perfect for 
  queries known at compile-time, however it is not possible to use it for building queries 
  dynamically at runtime. In this article I show that this can be actually done very well for 
  most of the common cases. The solution offered by Microsoft (mentioned in [<a href="#dynqlinks">1</a>]) is to 
  build query from a string, however this has many limitations and it in fact goes completely 
  against what LINQ tries to achieve, which is writing queries in a type-safe way with full 
  compile-time checking. In this article I will first show a few support functions to make the life 
  a bit easier and then we will use them for building two sample applications that allows user to 
  build a query dynamically. The solution is largely motivated by my previous use of F#, where 
  working with “expressions” is possible at more advanced level, however I’ll write about F# later 
  and now let’s get back to C# 3.0.</p>
  
<h2>Linq Utilities #1: Expandable Queries</h2>
<p>First of all, we will need an extension that I wrote some time ago, which allows us to “call functions in LINQ queries” as 
  demonstrated in the following example:</p>
<pre>
<span class="c">// Lambda expression that calculates the price</span>
Expression&lt;Func&lt;Nwind.Product, <span class="k">decimal</span>?&gt;&gt; calcPrice <span class="o">=</span> 
  (p) <span class="o">=</span>&gt; p.UnitPrice <span class="o">*</span> 1.19m;

<span class="c">// Query that selects products </span>
<span class="k">var</span> q <span class="o">=</span> 
  <span class="k">from</span> p <span class="k">in</span> db.Products.ToExpandable()  
  <span class="k">where</span> calcPrice.Expand(p) &gt; 30.0m
  <span class="k">select</span> <span class="k">new</span> { 
    p.ProductName, 
    OriginalPrice <span class="o">=</span> p.UnitPrice,
    ShopPrice <span class="o">=</span> calcPrice.Expand(p) };
</pre>

<p>It works relatively simple – you can write a function you want to call in a query using anonymous 
  function declared as an Expression, than you’ll have to add a ToExpandable call to the data table and finally, 
  you can call your functions (which are actually expressions) using the Expand extension method (note that 
  in the earlier versions I used Invoke, but the name conflicts with some standard functions in the newest beta 
  versions). You can read more about this in my earlier blog post [<a href="#dynqlinks">2</a>], but in an essence, the ToQueryable creates a 
  thin layer that processed the entire LINQ query before it is sent to the “LINQ to SQL” translator and it replaces 
  all occurrences of the Expand call with the body of the function, so that the “LINQ to SQL” can understand the query.
  The latest version of these extensions is available at CodePlex [<a href="#dynqlinks">3</a>], but the DLL is also included in the 
  downloads at the end of this article.</p>
  
<h2>Linq Utilities #2: Type Inference for Anonymous Functions</h2>
<p>The second little utility will allow us to use C# implicitly typed variables (using the var keyword) to declare 
  anonymous functions and lambda expressions (i.e. data representation of the anonymous function). As you probably know you, 
  the decision whether anonymous function will be compiled as a Func delegate (that can be invoked) or as an Expression data 
  structure (that can be for example translated to SQL) depends on the variable type:</p>

<pre>
Func&lt;<span class="k">int</span>,<span class="k">int</span>,<span class="k">int</span>&gt; func <span class="o">=</span> (<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; a <span class="o">+</span> b;
Expression&lt;Func&lt;<span class="k">int</span>,<span class="k">int</span>,<span class="k">int</span>&gt;&gt; expr <span class="o">=</span> (<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; a <span class="o">+</span> b;
</pre>
<p>Obviously the following code looks very confusing:</p>
<pre><span class="k">var</span> func <span class="o">=</span> (<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; a <span class="o">+</span> b;</pre>
<p>The problem is that the compiler doesn’t know if func should be of type Expression or Func and indeed, if you 
  try it you will get a compiler error message saying “Cannot assign lambda expression to an implicitly-typed local variable”. 
  Unfortunately this forces you to write the type, which can be really complicated sometimes and also this way of declaring 
  anonymous functions makes it impossible to write an anonymous function returning C# 3.0 anonymous type:</p>
  
<pre>Func&lt;<span class="k">int</span>,<span class="k">int</span>,<span class="o">?</span><span class="o">?</span><span class="o">?</span>&gt; func <span class="o">=</span> (<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; <span class="k">new</span> { Sum <span class="o">=</span> a <span class="o">+</span> b, Mul <span class="o">=</span> a <span class="o">*</span> b };</pre>
<p>When you want to return anonymous type you can no longer write name of the type (because it is anonymous!), so 
  writing expression like this looks like an impossible task. Luckily we can implement really simple workaround for this problem:</p>
<pre>
<span class="k">public</span> <span class="k">static</span> <span class="k">class</span> Linq {
  <span class="c">// Returns the given anonymous method as a lambda expression</span>
  <span class="k">public</span> <span class="k">static</span> Expression&lt;Func&lt;T, R&gt;&gt; 
      Expr&lt;T, R&gt;(Expression&lt;Func&lt;T, R&gt;&gt; f) {
    <span class="k">return</span> f;
  }

  <span class="c">// Returns the given anonymous function as a Func delegate</span>
  <span class="k">public</span> <span class="k">static</span> Func&lt;T, R&gt; 
      Func&lt;T, R&gt;(Func&lt;T, R&gt; f) {
    <span class="k">return</span> f;
  }
}</pre>
<p>You can see that we declared two simple static methods that just return the argument, however the type of the 
  argument (which is a Func delegate in case of the Func method and Expression data type in case of the Expr method) 
  tells the compiler if we want to build an expression or a delegate. Using this class we can rewrite the previous examples as following:</p>
<pre>
<span class="c">// Let’s start with the simple examples:</span>
<span class="k">var</span> func <span class="o">=</span> Linq.Func((<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; a <span class="o">+</span> b);
<span class="k">var</span> expr <span class="o">=</span> Linq.Expr((<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; a <span class="o">+</span> b);

<span class="c">// .. and using anonymous types is possible as well!</span>
<span class="k">var</span> func <span class="o">=</span> Linq.Func((<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; 
  <span class="k">new</span> { Sum <span class="o">=</span> a <span class="o">+</span> b, Mul <span class="o">=</span> a <span class="o">*</span> b });
<span class="k">var</span> expr <span class="o">=</span> Linq.Expr ((<span class="k">int</span> a, <span class="k">int</span> b) <span class="o">=</span>&gt; 
  <span class="k">new</span> { Sum <span class="o">=</span> a <span class="o">+</span> b, Mul <span class="o">=</span> a <span class="o">*</span> b });
</pre>
<p>Note that when using Linq.Func or Linq.Expr you have to explicitly specify the type of the arguments, because the 
  compiler can’t infer this from the type of the variable, however the code is usually shorter anyway and in addition you can use anonymous types!</p>

<h2>Dynamic Queries #1: Selecting Customers</h2>
<p>All right, let’s finally look how we can build a LINQ query dynamically at runtime! In the first example we will implement 
  one feature that may be quite common in a lot of applications. We will build a query for selecting customers from the 
  Northwind database and we will let user to choose what property of the <code>Customer</code> type he wants to enter. For simplicity 
  we will give a choice between <code>CompanyName</code>, <code>Country</code> and a <code>ContactName</code>. Once the user selects what property he wants to 
  query, we will ask for the value and run a query that will return all customers whose property selected by the user 
  contains the entered value (as a substring). To implement this we first create a data context and then we write a function 
  that will build a LINQ query once it gets a value entered by the user and a lambda expression representing a function 
  that reads the selected property from of the customer. It may sound a bit confusing, but I’ll explain everything soon:</p>
<pre>
NorthwindDataContext db <span class="o">=</span> <span class="k">new</span> NorthwindDataContext();

<span class="k">var</span> queryBuilder <span class="o">=</span> Linq.Func
  ((Expression&lt;Func&lt;Customer, <span class="k">string</span>&gt;&gt; selector, <span class="k">string</span> val) <span class="o">=</span>&gt;
      <span class="k">from</span> c <span class="k">in</span> db.Customers.ToExpandable()
      <span class="k">where</span> selector.Expand(c).IndexOf(val) <span class="o">!</span><span class="o">=</span> -1
      <span class="k">select</span> c);
</pre>
<p>Before digging deeper, let’s look how the queryBuilder function can be used:</p>
<pre>
<span class="k">var</span> q <span class="o">=</span> queryBuilder(c <span class="o">=</span>&gt; c.CompanyName, <span class="s">"ab"</span>);
<span class="k">foreach</span> (<span class="k">var</span> cust <span class="k">in</span> q)
  Console.WriteLine(cust);
</pre>
<p>So what exactly happens here? We built a function (or maybe parameterized query would be better name) called <code>queryBuilder</code> 
  that has two arguments. The second argument is a value that the user entered and the first argument is a lambda expression 
  (named <code>selector</code>) that specifies what property of the <code>Customer</code> type we want to look for – when we give it an anonymous method 
  that returns company name of a customer as an argument it will build a query that returns all customers with the specified company name.</p>
  
<p>When you run the code, it executes the <code>queryBuilder</code> function with the lambda expression reading company name and a value 
  “ab”. The <code>queryBuilder</code> then returns a query that calls the lambda expression using the <code>Expand</code> method which I talked about 
  earlier (in <strong>Linq Utilities #1</strong>). It is also important to note that the query uses the <code>ToExpandable</code> method, because this has to 
  be present anywhere where we want to use <code>Expand</code> to call some lambda expression in a LINQ query.</p>
  
<p>Let’s now finish the sample and write a code that actually allows user to choose how he wants to query the <code>Customers</code> data table:</p>
<pre>
<span class="k">var</span> dict <span class="o">=</span> <span class="k">new</span> Dictionary&lt;<span class="k">string</span>, Expression&lt;Func&lt;Customer, <span class="k">string</span>&gt;&gt;&gt; 
  { { <span class="s">"CompanyName"</span>, c <span class="o">=</span>&gt; c.CompanyName },
    { <span class="s">"Country"</span>,     c <span class="o">=</span>&gt; c.Country },
    { <span class="s">"ContactName"</span>, c <span class="o">=</span>&gt; c.ContactName } };

<span class="c">// Get the input from the user</span>
Console.Write(<span class="s">"Filter - field name (CompanyName, ContactName, Country):\n&gt; "</span>);
<span class="k">string</span> field <span class="o">=</span> Console.ReadLine();

Console.Write(<span class="s">"Filter - value:\n&gt; "</span>);
<span class="k">string</span> <span class="k">value</span> <span class="o">=</span> Console.ReadLine();

<span class="c">// Build the query using query builder and run it</span>
<span class="k">var</span> q <span class="o">=</span> queryBuilder(dict[field], <span class="k">value</span>);
<span class="k">foreach</span> (<span class="k">var</span> cust <span class="k">in</span> q)
  Console.WriteLine(cust);
</pre>
<p>The application (just a simple console program) creates a dictionary that contains string as a key and a lambda 
  expression for reading specific properties of a customer as a value. When user enters a string representing the 
  property, it looks it up in the dictionary and gets a lambda expression that can be given as an argument to our 
  parameterized query declared earlier. And that’s all! You could very easily use the same principle in a Windows 
  Forms applications and let user select the property for example from a drop down list, which is probably the most 
  common scenario for building LINQ queries at runtime.</p>

<h2>Dynamic Queries #2: Combining Functions Using “OR” and “AND”</h2>
<p>In this example, we will write slightly more complex application that builds LINQ query dynamically.
  It will allow user to choose if he wants to combine several criteria using <code>AND</code> or <code>OR</code>
  logical operator and then enter the values to find for every property (again, we use <code>Customer</code> 
  table from a Northwind database). This means that the user we will be able to enter queries like <code>(CompanyName = "Google") OR 
  (Country = "Czech Republic")</code> or <code>(CompanyName = "Microsoft") AND (Country = "USA")</code>. The key aspect in
  this example is that query is combined from several basic conditions without knowing the number of these conditions in advance, 
  so this principle could be used when you want to allow the user to add any number of conditions he wants.
</p>
<p>We will again need a dictionary for mapping string (entered by the user) to a lambda expression returning
  the property of the <code>Customer</code> object. To make the code a bit more readable then in the previous example
  we will define an abbreviation for this rather complex type, which can be done thanks to the C# <code>using</code> construct
  (unfortunately there are a few limitations, so we have to use fully qualified namespace names):
  </p>
<pre>
<span class="k">using</span> CustomerPropSelector <span class="o">=</span> System.Linq.Expressions
  .Expression&lt;System.Func&lt;EeekSoft.LinqDemos.Customer, <span class="k">string</span>&gt;&gt;;
</pre>
<p>Now we can use the <code>CustomerPropSelector</code> type as a value in a dictionary (it is actually the
  same dictionary as the one we used in the previous example):</p>
<pre>
NorthwindDataContext db <span class="o">=</span> <span class="k">new</span> NorthwindDataContext();
<span class="k">var</span> dict <span class="o">=</span> <span class="k">new</span> Dictionary&lt;<span class="k">string</span>, CustomerPropSelector&gt; 
   { { <span class="s">"CompanyName"</span>, c <span class="o">=</span>&gt; c.CompanyName },
     { <span class="s">"Country"</span>,     c <span class="o">=</span>&gt; c.Country },
     { <span class="s">"ContactName"</span>, c <span class="o">=</span>&gt; c.ContactName } };
</pre>
<p>The next type abbreviation that we will use in the code will represent a condition telling whether
  specified customer matches the specified criteria or not. The condition is a lambda expression
  taking a <code>Customer</code> object as an argument and returning a boolean value:</p>
<pre>
<span class="k">using</span> CustomerCondition <span class="o">=</span> System.Linq.Expressions
  .Expression&lt;System.Func&lt;EeekSoft.LinqDemos.Customer, <span class="k">bool</span>&gt;&gt;;
</pre>
<p>We can now define two primitive conditions that we will need later - to define a condition
  we use the C# anonymous function syntax, so you can easily write a condition that for example
  tests whether a customer is from UK or something like that. The two primitive conditions that we need
  are however really trivial - one of them returns <code>true</code> for every customer and the other <code>false</code>:  </p>
<pre>
CustomerCondition trueCond  <span class="o">=</span> (c) <span class="o">=</span>&gt; <span class="k">true</span>;
CustomerCondition falseCond <span class="o">=</span> (c) <span class="o">=</span>&gt; <span class="k">false</span>;
</pre>
<p>Now, we will need a way for combining two conditions, so we can write a <em>combinator</em> that can be used
  to produce a condition from two of them. We will use two such combinators later. One will be <code>OR</code> which 
  takes two conditions and returns <code>true</code> when any of them returns <code>true</code> and the other
  will be <code>AND</code> which will return <code>true</code> when both conditions return <code>true</code>, 
  as you would expect. The interesting is the type of these combinators - it is a function taking two conditions
  and returning a condition as a result, so we could write them as <code>Func&lt;CustomerCondition, CustomerCondition, CustomerCondition&gt;</code>.
  Unfortunately, the C# <code>using</code> statement doesn't allow using nested abbreviations, so we have to 
  replace <code>CustomerCondition</code> in the previous type and we'll get somewhat ugly type:
</p>

<pre>
<span class="k">using</span> CustomerConditionCombinator <span class="o">=</span> 
  System.Func&lt;System.Linq.Expressions.Expression&lt;System.Func&lt;EeekSoft.LinqDemos.Customer, <span class="k">bool</span>&gt;&gt;, 
              System.Linq.Expressions.Expression&lt;System.Func&lt;EeekSoft.LinqDemos.Customer, <span class="k">bool</span>&gt;&gt;, 
              System.Linq.Expressions.Expression&lt;System.Func&lt;EeekSoft.LinqDemos.Customer, <span class="k">bool</span>&gt;&gt;&gt;;
</pre>
<p>Despite the fact that C# forces us to write this in a really ugly way, it isn't that difficult to understand what it actually does - 
  it just takes two conditions (which are actually lambda expressions returning a boolean value when given 
  <code>Customer</code> as an argument) and returns a condition that can call these two conditions and produces 
  boolean as a result, very likely by performing some logical operation on the values
  returned by these two conditions. We can now write two basic combinators for logical <code>OR</code> and <code>AND</code>.
  The combinator receives two conditions (<code>f</code> and <code>g</code>) as arguments, and returns a
  new lambda expression as the result. This lambda expression takes a <code>Customer</code> value as an argument,
  calls the two conditions using the <code>Expand</code> method and performs the logical operation on the result: </p>
<pre>
CustomerConditionCombinator combineOr <span class="o">=</span> 
  (f, g) <span class="o">=</span>&gt; (c) <span class="o">=</span>&gt; f.Expand(c) <span class="o">|</span><span class="o">|</span> g.Expand(c);

CustomerConditionCombinator combineAnd <span class="o">=</span> 
  (f, g) <span class="o">=</span>&gt; (c) <span class="o">=</span>&gt; f.Expand(c) &amp;&amp; g.Expand(c);
</pre>

<p>Now we have everything we need to finally start building the query! Let me first demonstrate how we can
  build a query using the <code>combineOr</code> combinator from two simple conditions, one testing whether
  the customer is from UK and the other testing if it's from Seattle:</p>
<pre>
<span class="c">// Define two simple conditions first</span>
CustomerCondition isUk <span class="o">=</span> (c) <span class="o">=</span>&gt; c.Country <span class="o">=</span><span class="o">=</span> <span class="s">"UK"</span>;
CustomerCondition isSeattle <span class="o">=</span> (c) <span class="o">=</span>&gt; c.City <span class="o">=</span><span class="o">=</span> <span class="s">"Seattle"</span>

<span class="c">// Combine the conditions using OR</span>
CustomerCondition expr <span class="o">=</span> combineOr(isUk, isSeattle);

<span class="c">// Build a query (using 'Expand' and 'ToExpandable')</span>
<span class="k">var</span> q <span class="o">=</span> <span class="k">from</span> c <span class="k">in</span> db.Customers.ToExpandable()
        <span class="k">where</span> expr.Expand(c) <span class="k">select</span> c;
</pre>
<p>If you run this example, it will indeed return all customers that are either from UK or live in Seattle.
  Note that we still have to use the <code>Expand</code> to call the condition we built in the 
  LINQ query and it is also important not to forget the <code>ToExpandable</code> call, otherwise the “LINQ to SQL”
  will give an error message that it doesn't understand the query. </p>
<p>Let's now move to the final example - here we will actually let user construct a query he wants. Let's assume
  we have a value <code>generateOr</code> saying if we want to build a query by combinating several conditions using
  <code>OR</code> or using <code>AND</code>. To build a query we will start with one of our primitive conditions and
  add a condition using the combinator for every property of the customer. This means that when combining conditions
  using <code>OR</code> we will start with a query representing <code>"false"</code>, than we will append first condition
  and get something like <code>"(false || cond1)"</code>, after adding second condition we will get
  <code>"(false || cond1) || cond2"</code> and so on. You can see that when building a sequence of 
  <code>OR</code>s we need to start with <code>falseCond</code>, so that the condition returns <code>true</code> only
  when any of the conditions succeeds and when building sequence of <code>AND</code>s, we have to start with <code>trueCond</code>, 
  so that the condition succeeds when all conditions return <code>true</code>.</p>
<p>The code to build a condition in the way described in the previous paragraph can be written as a <code>foreach</code> loop
  (working with the <code>KeyValuePair</code> from the dictionary declared above) that modifies the variable
  holding the current expression (<code>expr</code>) in every iteration:</p>
<pre>
<span class="c">// Select the combinator and initial condition</span>
CustomerConditionCombinator combinator <span class="o">=</span> 
  generateOr <span class="o">?</span> combineOr <span class="o">:</span> combineAnd;
CustomerCondition expr <span class="o">=</span> 
  generateOr <span class="o">?</span> falseCond <span class="o">:</span> trueCond;
  
<span class="c">// Loop over all properties in the dictionary  </span>
<span class="k">foreach</span> (<span class="k">var</span> item <span class="k">in</span> dict)
{
  <span class="c">// Read the value from the user</span>
  Console.Write(<span class="s">"Enter value for '{0}':\n&gt; "</span>, item.Key);
  <span class="k">string</span> enteredVal <span class="o">=</span> Console.ReadLine();
  CustomerPropSelector propSelector <span class="o">=</span> item.Value;
  
  <span class="c">// Build a condition testing whether entered value is a substring</span>
  CustomerCondition currentCond <span class="o">=</span> (c) <span class="o">=</span>&gt; 
    propSelector.Expand(c).IndexOf(enteredVal) <span class="o">!</span><span class="o">=</span> -1;
    
  <span class="c">// Finally, combine expressions using the combinator</span>
  expr <span class="o">=</span> combinator(expr, currentCond);
}
</pre>
<p>Since C# 3.0 and LINQ in general use some of the concepts from functional programming, we can actually used
  one nice functional trick to write the code in a slightly shorter and less error-prone way. We can use
  a query operator called <code>Fold</code> (it was part of the LINQ in earlier version, but it seems to be missing
  now, so I added it to my LINQ Extensions [<a href="#dynqlinks">3</a>] project). What does this operation do?
  It takes some initial value and runs a specified function to combine the value with every element in the 
  sequence step by step. In our case the initial value is a condition (either <code>trueCond</code> or <code>falseCond</code>)
  and the function to combine values is essentially the body of the <code>foreach</code> loop. This means that
  function will ask user for the value and return the value newly produced by the combinator:</p>
  
<pre>
CustomerConditionCombinator combinator <span class="o">=</span> 
  generateOr <span class="o">?</span> combineOr <span class="o">:</span> combineAnd;

<span class="c">// Build expression using the 'Fold' aggregate operator</span>
<span class="k">var</span> expr <span class="o">=</span> dict.Fold((e, item) <span class="o">=</span>&gt; {
    <span class="c">// Read the value from the user</span>
    Console.Write(<span class="s">"Enter value for '{0}':\n&gt; "</span>, item.Key);
    <span class="k">string</span> enteredVal <span class="o">=</span> Console.ReadLine();
    CustomerPropSelector propSelector <span class="o">=</span> item.Value;    
    
    <span class="c">// Build a condition testing whether entered value is a substring</span>
    CustomerCondition currentCond <span class="o">=</span> (c) <span class="o">=</span>&gt; 
      propSelector.Expand(c).IndexOf(enteredVal) <span class="o">!</span><span class="o">=</span> -1;
      
    <span class="c">// Finally, return the combined expression</span>
    <span class="k">return</span> combinator(e, currentCond); 
  }, generateOr <span class="o">?</span> falseCond <span class="o">:</span> trueCond);
</pre>

<p>Finally, we can use a simple LINQ query to run the generated condition (<code>expr</code> variable) - as mentioned in 
  other places of this article, we can call it using <code>Expand</code> and we shouldn't forgot <code>ToExpandable</code>
  call which processes our combined expression before calling the “LINQ to SQL” translator:</p>
<pre>
<span class="k">var</span> q <span class="o">=</span> <span class="k">from</span> c <span class="k">in</span> db.Customers.ToExpandable()
        <span class="k">where</span> expr.Expand(c) <span class="k">select</span> c;
</pre>
<h2>Summary</h2>
<p>I hope this article convinced you that there is quite reasonable way for building queries dynamically at runtime in LINQ,
  which is much safer and less error-prone than building a string. Even though it may look complicated at the beginning after
  defining a few primitive constructs the code for building queries looks reasonable and is also extensible, so you're not limited
  to combining conditions sequentially using only two operators as I demonstrated in the example, in fact it could be easily
  modified to build for example a tree representing more complex logical combinations of conditions.
  To run this code you'll need a few (not very difficult to write, but important) extensions that are part of my LINQ Extensions
  project available at CodePlex. Finally, I'd like to give a credit to the authors of the F# language where this kind of expression
  processing is natively supported, because without my experiences with F# I probably wouldn't think of building queries in a way
  I present it in this article.
  </p>

<h2>Downloads and Related Links<a name="dynqlinks"></a></h2>
<ul>
<li><a href="/articles/dynamic-linq-queries/sources.zip">Download the examples</a> (51 kB)</li>
</ul>
<ul>
  <li>[1] <a href="http://209.85.135.104/search?hl=en&q=cache%3Ahttp%3A%2F%2Fforums.microsoft.com%2FMSDN%2FShowPost.aspx%3FPostID%3D1752078%26SiteID%3D1">Dynamic SQL and LINQ, Post by Anders Hejlsberg</a>
    [<a href="http://209.85.135.104/search?hl=en&q=cache%3Ahttp%3A%2F%2Fforums.microsoft.com%2FMSDN%2FShowPost.aspx%3FPostID%3D1752078%26SiteID%3D1" target="_blank">^</a>] - MSDN Forums - LINQ</li>
  <li>[2] <a href="http://tomasp.net/blog/linq-expand.aspx">Calling functions in LINQ queries</a>
    [<a href="http://tomasp.net/blog/linq-expand.aspx">^</a>] - Blog | TomasP.Net</li>    
  <li>[3] <a href="http://www.codeplex.com/linqextensions">LINQ Extensions</a>
    [<a href="http://www.codeplex.com/linqextensions" target="_blank">^</a>] - CodePlex</li>
</ul>



<div class="row">
  <div class="small-6 columns"><p class="post-discuss">
		Discuss <a href="http://twitter.com/tomaspetricek">on twitter</a>, <script type="text/javascript" src="http://www.reddit.com/buttonlite.js?i=0"></script>.<br />
		Send corrections via <a href="https://github.com/tpetricek/TomaspNet.Website">GitHub pull requests</a>.
	</p></div>
  <div class="small-6 columns">

<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_16x16_style">
<a class="addthis_button_twitter"></a>
<a class="addthis_button_reddit"></a>
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_hackernews"></a>
<a class="addthis_button_facebook"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = { "data_track_addressbar": false };</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-521c32162e6001a0"></script>
<!-- AddThis Button END -->

<p class="post-meta">
  <span><strong>Published</strong> Monday, 30 July 2007, 2:10 AM</span><br />      
  <span><strong>By</strong> <a href="https://plus.google.com/+TomasPetriceks?rel=author">Tomas Petricek</a></span><br />
  <span class="tags"><strong>Tags</strong> C# language</span>
</p>

  </div>
</div>

    </content>

  </div>
  <div class="large-4 columns" id="right-bar">
    <div class="right-item" id="right-calendar">
<script type="text/javascript">
  var monthNames =
    ["January", "February", "March", "April", "May", "June",
      "July", "August", "September", "October", "November", "December"];
  var d = new Date();
  var m = monthNames[d.getMonth()];
  var y = d.getFullYear();
  var ml = m.toLowerCase();
  document.writeln("<h4>Calendar - " + m + " " + y + "</h4>");
  document.writeln("<a href=\"http://tomasp.net/calendar/" + y + "/" + ml + ".html\">" +
    "<img src=\"http://tomasp.net/calendar/" + y + "/" + ml + "-preview.jpg\" style=\"border-style:none;\" />" +
    "</a>");
</script>
<p>The calendar shows a new picture each month. See photos for
  <a href="http://tomasp.net/calendar/2005">2005</a>, <a href="http://tomasp.net/calendar/2006">2006</a>,
  <a href="http://tomasp.net/calendar/2007">2007</a>, <a href="http://tomasp.net/calendar/2008">2008</a>,
  <a href="http://tomasp.net/calendar/2009">2009</a>, <a href="http://tomasp.net/calendar/2010">2010</a>,
  <a href="http://tomasp.net/calendar/2011">2011</a>, <a href="http://tomasp.net/calendar/2012">2012</a>,
  <a href="http://tomasp.net/calendar/2013">2013</a>, <a href="http://tomasp.net/calendar/2014">2014</a>,
  <a href="http://tomasp.net/calendar/2015">2015</a>
  and the first photos of <a href="http://tomasp.net/calendar/2016">2016</a>.
</p>
</div>


    <h3>Welcome!</h3>
    <img src="http://tomasp.net/img/tomas.jpg" alt="Tomas Petricek" style="float:right;margin:10px 0px 10px 10px;" />
    <p>I'm an F# open-source developer, book author and computer scientist. I submitted my PhD thesis recently.
      When offline, I enjoy traveling and taking pictures. You can find me at
      at <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a> or email 
      <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a>.
    </p>

    <h4>Trainings and consulting</h4>
    <a href="http://fsharpworks.com"><img src="http://tomasp.net/img/fsharpworks.png" alt="fsharpWorks" style="float:right;margin:15px 0px 10px 10px; width:150px" /></a>
    <p>I'm an experienced F# developer and trainer. <br /> I offer training and consulting
      services through <a href="http://fsharpworks.com">fsharpWorks</a>.
    </p>
    <ul>
      <li>Check out my <a href="http://fsharpworks.com/workshops/fast-track.html">in-person Fast Track to F#</a> course</li>
      <li>Check out my <a href="http://fsharpworks.com/workshops/finance.html">online F# in Finance</a> course</li>
      <li><a href="mailto:tomas@tomasp.net">Email me</a> for info about private trainings</li>
    </ul>
    
    <script type="text/javascript" src="http://tomasp.net/news/news.js"></script>
    <h4>What's new? &#160; <small><script type="text/javascript">document.write(news.date)</script></small></h4>
    <script>
      document.write(news.info);
    </script>

    <h4>Functional F# and C# books</h4>
    <div style="float:right;">
      <a href="http://www.amazon.com/gp/product/1933988924/ref=as_li_tf_il?ie=UTF8&tag=httptomasnet-20&linkCode=as2&camp=217145&creative=399369&creativeASIN=1933988924">
        <img src="http://tomasp.net/img/deepdives.png" alt="F# Deep Dives" style="float:right;margin:15px 0px 15px 10px;border-style:none;" />
      </a>
    </div>
    <p>
      I wrote or contributed to two books on F# and functional programming:
      <a href="http://functional-programming.net/rwfp">Real World Functional Programming</a> explains functional
      concepts using F# and C# and <a href="http://functional-programming.net/deepdives">F# Deep Dives</a> is a 
      collection of case studies written by industry experts.</p>
    <ul>
      <li><a href="http://functional-programming.net/rwfp"><strong>Real World Functional Programming</strong></a> home page. See
        <a href="http://manning.com/petricek">Manning</a>,
        <a href="https://www.amazon.com/dp/1933988924?tag=httptomasnet-20&camp=213381&creative=390973&linkCode=as4&creativeASIN=1933988924&adid=0F1DP260JGG4KY0CDGP6">Amazon.com</a> or
        <a href="https://www.amazon.co.uk/dp/1933988924?tag=tomasnet-21&camp=1406&creative=6394&linkCode=as1&creativeASIN=1933988924&adid=1CTY87YCCQEJW965GNDF">Amazon.co.uk</a>.
      </li>
      <li><a href="http://functional-programming.net/deepdives"><strong>F# Deep Dives</strong></a> home page. Get it from
        <a href="http://www.manning.com/petricek2">Manning.com</a>,
        <a href="http://www.amazon.com/gp/product/1617291323/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=1617291323&linkCode=as2&tag=httptomasnet-20&linkId=U4FPJJSKKCCKGNHD">Amazon.com</a> or
        <a href="http://www.amazon.co.uk/gp/product/1617291323/ref=as_li_tl?ie=UTF8&camp=1634&creative=19450&creativeASIN=1617291323&linkCode=as2&tag=tomasnet-21&linkId=HTUYVHHGWB4Q7X6V">Amazon.co.uk</a>.
      </li>
    </ul>    
    <p>I also wrote a series of tutorials on <a href="http://www.tryfsharp.org/Learn/financial-computing">financial computing for Try F#</a>.
      This interactive environment let's you try F# in the browser.</p>

    <h4>Research and teaching</h4>
    <img src="http://tomasp.net/img/cam.png" alt="University of Cambride" style="float:right;margin:25px 0px 10px 10px;" />
    <p>I submitted my PhD thesis at the <a href="http://www.cl.cam.ac.uk/">University of Cambridge</a>,
      working on making better types for programs that run in rich context (like F# type providers, distributed 
      prog&shy;ramming or data-flow). See <a href="http://tomasp.net/academic/">my academic page</a> for
      more.</p>

    <h4>Blog tags</h4>
    <p>

      <a href="http://tomasp.net/blog/tag/fsharp/">f#</a>&nbsp;(109),       <a href="http://tomasp.net/blog/tag/research/">research</a>&nbsp;(34),       <a href="http://tomasp.net/blog/tag/functional-programming/">functional programming</a>&nbsp;(18),       <a href="http://tomasp.net/blog/tag/data-science/">data science</a>&nbsp;(6),       <a href="http://tomasp.net/blog/tag/web/">web</a>&nbsp;(10),       <a href="http://tomasp.net/blog/tag/talks/">talks</a>&nbsp;(7),       <a href="http://tomasp.net/blog/tag/philosophy/">philosophy</a>&nbsp;(4),       <a href="http://tomasp.net/blog/tag/fslab/">fslab</a>&nbsp;(4),       <a href="http://tomasp.net/blog/tag/programming-languages/">programming languages</a>&nbsp;(3),       <a href="http://tomasp.net/blog/tag/type-providers/">type providers</a>&nbsp;(3),       <a href="http://tomasp.net/blog/tag/data-journalism/">data journalism</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/coeffects/">coeffects</a>&nbsp;(2),       <a href="http://tomasp.net/blog/tag/visualization/">visualization</a>&nbsp;(1),       <a href="http://tomasp.net/blog/tag/machine-learning/">machine learning</a>&nbsp;(1)    </p>

  </div>
</div>


  <div class="row" id="footer">
  <footer>
    <div class="large-3 columns">
      <h4>Contact & about</h4>
      <p>This site is hosted on GitHub and is generated using <a href="https://github.com/tpetricek/FSharp.Formatting">F# Formatting</a>.
        For more info, see the <a href="https://github.com/tpetricek/TomaspNet.Website">website source on GitHub</a>.
      </p>
      <p>Please submit issues & corrections on GitHub. Use pull requests for minor corrections only.</p>
      <ul>
        <li>Email me: <a href="mailto:tomas@tomasp.net">tomas@tomasp.net</a></li>
        <li>Connect via Twitter: <a href="http://twitter.com/tomaspetricek">@tomaspetricek</a></li>
        <li>More: <a href="http://uk.linkedin.com/in/tomaspetricek">LinkedIn</a> | <a href="http://lanyrd.com/profile/tomasp/">Lanyrd</a> | <a href="https://github.com/tpetricek">GitHub</a></li>
      </ul>
    </div>
    <div class="large-7 columns">
    <h4>Blog archives <a href="http://tomasp.net/rss.xml"><img src="http://tomasp.net/img/rss.gif" /></a></h4>
      <a href="http://tomasp.net/blog/archive/april-2016/index.html">
        April 2016 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2015/index.html">
        December 2015 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2015/index.html">
        November 2015 (1)</a>,      <a href="http://tomasp.net/blog/archive/september-2015/index.html">
        September 2015 (3)</a>,      <a href="http://tomasp.net/blog/archive/july-2015/index.html">
        July 2015 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2015/index.html">
        June 2015 (1)</a>,      <a href="http://tomasp.net/blog/archive/may-2015/index.html">
        May 2015 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2015/index.html">
        April 2015 (3)</a>,      <a href="http://tomasp.net/blog/archive/march-2015/index.html">
        March 2015 (2)</a>,      <a href="http://tomasp.net/blog/archive/february-2015/index.html">
        February 2015 (1)</a>,      <a href="http://tomasp.net/blog/archive/january-2015/index.html">
        January 2015 (2)</a>,      <a href="http://tomasp.net/blog/archive/december-2014/index.html">
        December 2014 (1)</a>,      <a href="http://tomasp.net/blog/archive/may-2014/index.html">
        May 2014 (3)</a>,      <a href="http://tomasp.net/blog/archive/april-2014/index.html">
        April 2014 (2)</a>,      <a href="http://tomasp.net/blog/archive/march-2014/index.html">
        March 2014 (1)</a>,      <a href="http://tomasp.net/blog/archive/january-2014/index.html">
        January 2014 (2)</a>,      <a href="http://tomasp.net/blog/archive/december-2013/index.html">
        December 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/november-2013/index.html">
        November 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/october-2013/index.html">
        October 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/september-2013/index.html">
        September 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/august-2013/index.html">
        August 2013 (2)</a>,      <a href="http://tomasp.net/blog/archive/may-2013/index.html">
        May 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/april-2013/index.html">
        April 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2013/index.html">
        March 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/february-2013/index.html">
        February 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/january-2013/index.html">
        January 2013 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2012/index.html">
        December 2012 (2)</a>,      <a href="http://tomasp.net/blog/archive/october-2012/index.html">
        October 2012 (1)</a>,      <a href="http://tomasp.net/blog/archive/august-2012/index.html">
        August 2012 (3)</a>,      <a href="http://tomasp.net/blog/archive/june-2012/index.html">
        June 2012 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2012/index.html">
        April 2012 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2012/index.html">
        March 2012 (4)</a>,      <a href="http://tomasp.net/blog/archive/february-2012/index.html">
        February 2012 (5)</a>,      <a href="http://tomasp.net/blog/archive/january-2012/index.html">
        January 2012 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2011/index.html">
        November 2011 (5)</a>,      <a href="http://tomasp.net/blog/archive/august-2011/index.html">
        August 2011 (3)</a>,      <a href="http://tomasp.net/blog/archive/july-2011/index.html">
        July 2011 (2)</a>,      <a href="http://tomasp.net/blog/archive/june-2011/index.html">
        June 2011 (2)</a>,      <a href="http://tomasp.net/blog/archive/may-2011/index.html">
        May 2011 (2)</a>,      <a href="http://tomasp.net/blog/archive/march-2011/index.html">
        March 2011 (4)</a>,      <a href="http://tomasp.net/blog/archive/december-2010/index.html">
        December 2010 (1)</a>,      <a href="http://tomasp.net/blog/archive/november-2010/index.html">
        November 2010 (6)</a>,      <a href="http://tomasp.net/blog/archive/october-2010/index.html">
        October 2010 (6)</a>,      <a href="http://tomasp.net/blog/archive/september-2010/index.html">
        September 2010 (4)</a>,      <a href="http://tomasp.net/blog/archive/july-2010/index.html">
        July 2010 (3)</a>,      <a href="http://tomasp.net/blog/archive/june-2010/index.html">
        June 2010 (2)</a>,      <a href="http://tomasp.net/blog/archive/may-2010/index.html">
        May 2010 (1)</a>,      <a href="http://tomasp.net/blog/archive/february-2010/index.html">
        February 2010 (2)</a>,      <a href="http://tomasp.net/blog/archive/january-2010/index.html">
        January 2010 (3)</a>,      <a href="http://tomasp.net/blog/archive/december-2009/index.html">
        December 2009 (3)</a>,      <a href="http://tomasp.net/blog/archive/july-2009/index.html">
        July 2009 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2009/index.html">
        June 2009 (3)</a>,      <a href="http://tomasp.net/blog/archive/may-2009/index.html">
        May 2009 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2009/index.html">
        April 2009 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2009/index.html">
        March 2009 (2)</a>,      <a href="http://tomasp.net/blog/archive/february-2009/index.html">
        February 2009 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2008/index.html">
        December 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/november-2008/index.html">
        November 2008 (5)</a>,      <a href="http://tomasp.net/blog/archive/october-2008/index.html">
        October 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/september-2008/index.html">
        September 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2008/index.html">
        June 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/march-2008/index.html">
        March 2008 (3)</a>,      <a href="http://tomasp.net/blog/archive/february-2008/index.html">
        February 2008 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2007/index.html">
        December 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2007/index.html">
        November 2007 (6)</a>,      <a href="http://tomasp.net/blog/archive/october-2007/index.html">
        October 2007 (1)</a>,      <a href="http://tomasp.net/blog/archive/september-2007/index.html">
        September 2007 (1)</a>,      <a href="http://tomasp.net/blog/archive/august-2007/index.html">
        August 2007 (1)</a>,      <a href="http://tomasp.net/blog/archive/july-2007/index.html">
        July 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2007/index.html">
        April 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/march-2007/index.html">
        March 2007 (3)</a>,      <a href="http://tomasp.net/blog/archive/february-2007/index.html">
        February 2007 (3)</a>,      <a href="http://tomasp.net/blog/archive/january-2007/index.html">
        January 2007 (2)</a>,      <a href="http://tomasp.net/blog/archive/november-2006/index.html">
        November 2006 (1)</a>,      <a href="http://tomasp.net/blog/archive/october-2006/index.html">
        October 2006 (3)</a>,      <a href="http://tomasp.net/blog/archive/august-2006/index.html">
        August 2006 (2)</a>,      <a href="http://tomasp.net/blog/archive/july-2006/index.html">
        July 2006 (1)</a>,      <a href="http://tomasp.net/blog/archive/june-2006/index.html">
        June 2006 (3)</a>,      <a href="http://tomasp.net/blog/archive/may-2006/index.html">
        May 2006 (2)</a>,      <a href="http://tomasp.net/blog/archive/april-2006/index.html">
        April 2006 (2)</a>,      <a href="http://tomasp.net/blog/archive/december-2005/index.html">
        December 2005 (1)</a>,      <a href="http://tomasp.net/blog/archive/july-2005/index.html">
        July 2005 (4)</a>,      <a href="http://tomasp.net/blog/archive/june-2005/index.html">
        June 2005 (5)</a>,      <a href="http://tomasp.net/blog/archive/may-2005/index.html">
        May 2005 (1)</a>,      <a href="http://tomasp.net/blog/archive/april-2005/index.html">
        April 2005 (3)</a>,      <a href="http://tomasp.net/blog/archive/march-2005/index.html">
        March 2005 (3)</a>,      <a href="http://tomasp.net/blog/archive/january-2005/index.html">
        January 2005 (1)</a>,      <a href="http://tomasp.net/blog/archive/december-2004/index.html">
        December 2004 (3)</a>,      <a href="http://tomasp.net/blog/archive/november-2004/index.html">
        November 2004 (2)</a>,    </div>
    <div class="large-2 columns">
      <h4>License</h4>
      <p>Unless explicitly mentioned, all articles on this site are licensed under <a href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution Share Alike</a>.
        All source code samples are licensed under Apache 2.0.
      </p>
      <img src="http://tomasp.net/img/cc-sa.png" alt="CC License logo" />
    </div>
  </footer>
  </div>

  <script>
  document.write('<script src=' +
  ('__proto__' in {} ? 'http://tomasp.net/js/vendor/zepto' : 'http://tomasp.net/js/vendor/jquery') +
  '.js><\/script>')
  </script>

  <script src="http://tomasp.net/js/foundation.min.js"></script>
  <script>
    $(document).foundation();
  </script>
  <script type="text/javascript">

    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1561220-1']);
    _gaq.push(['_trackPageview']);

    (function () {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();

  </script>
  <script src="http://cdn.lanyrd.net/badges/person-v1.min.js"></script>
</body>
</html>
